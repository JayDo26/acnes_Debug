import e from'./../../../../external/@swc/helpers/src/_async_to_generator.mjs.js';import t from'./../../../../external/@swc/helpers/src/_object_spread.mjs.js';import o from'./../../../../external/@swc/helpers/src/_object_spread_props.mjs.js';import r from"../../../token.js";import n from"../../../../utils/query-string.js";import{apiResponse as s}from"../../../../utils/response.js";import{PAYMENT_H5_URL as a,PAYMENT_APIS as i,APP_ID as p}from"../../../../constants.js";import m from"../openWebview.js";import{MPEEmitter as d}from"../../../eventEmitter.js";import c from"./checkTransaction.js";import{getZaloVersionCode as u}from"../../../utils.js";import{__generator as f}from'./../../../../external/tslib/tslib.es6.js';import l from"../../../../appEnv/getEnv.js";import{Events as h}from"../../../../types/enum.js";var j,w=(j=e((function(j,w,g,y,b,C,I){var _,v,R,O,S,E,T,N,P,k,A,U,z,J,q,x,L,B,V,W,D;return f(this,(function(F){switch(F.label){case 0:_=p,(v=new URLSearchParams).append("amount",j.toString()),v.append("item",encodeURIComponent(JSON.stringify(w))),v.append("appId",_),g&&v.append("desc",encodeURIComponent(g)),y&&(R=y,"object"==typeof y&&(R=JSON.stringify(y)),v.append("extradata",encodeURIComponent(R))),b&&(O=b,"object"==typeof b&&(O=JSON.stringify(b)),v.append("payload",encodeURIComponent(O))),C&&("string"==typeof C?(v.append("method",C),v.append("isCustom","false")):"object"==typeof C&&(v.append("method",C.id),v.append("isCustom",JSON.stringify(C.isCustom)))),I&&v.append("mac",I),S={headers:{"Content-Type":"application/x-www-form-urlencoded",authorization:"Bearer "}},F.label=1;case 1:return F.trys.push([1,6,,7]),[4,r.getAccessToken().catch((function(){throw s.error.loginRequired}))];case 2:return T=F.sent(),S.headers.authorization="Bearer ".concat(T),[4,fetch(i.CREATE_ORDER,o(t({method:"POST"},S),{body:v}))];case 3:return[4,F.sent().json()];case 4:if(!(N=F.sent()).data||0!==N.err)throw s.error.badRequest(N.msg);return P=N.data.id,k=N.data.jwt,A=N.data.messageToken||"",U=window.APP_VERSION,z=window.APP_ENV,J={miniAppId:_,orderId:P},q=N.data.method,x=N.data.isCustom,k&&(J.token=k),U&&(J.version=U),z&&(J.env=z),q&&(J.method=q),x&&(J.isCustom=x),L=n.encode(J),B=new URL("?".concat(L),a).toString(),V=u(),W=((null===(E=l())||void 0===E?void 0:E.platformName)||"").toLowerCase(),[4,m(B,{style:"android"===W&&V<742?"normal":"bottomSheet"}).then((function(){var r=!1;d.getInstance().once(h.WebviewClosed,(function(){setTimeout(e((function(){var e;return f(this,(function(n){switch(n.label){case 0:return r?[3,2]:[4,c({zmpOrderId:P})];case 1:(e=n.sent()).err>=0&&!e.isCustom&&d.getInstance().emit(h.PaymentClose,e.err,o(t({},e),{zmpOrderId:P})),n.label=2;case 2:return[2]}}))})),500)})),d.getInstance().once(h.OpenApp,(function(){r=!0}))}))];case 5:return F.sent(),[2,{orderId:P,messageToken:A}];case 6:throw D=F.sent(),console.log("Internal error"),D;case 7:return[2]}}))})),function(e,t,o,r,n,s,a){return j.apply(this,arguments)});export{w as default};
